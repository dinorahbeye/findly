<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Location</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 85vh; width: 100%; }
        .avatar-marker { 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            border: 2px solid #ffffff; 
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        body { background-color: #1f2937; }
        .leaflet-container { background: #1f2937; } /* Темный фон карты */
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="flex flex-col min-h-screen">
        <header class="bg-gray-800 p-3 shadow-md">
            <h1 class="text-lg font-semibold text-center">Findly</h1>
        </header>
        <main class="flex-grow">
            <div id="map"></div>
            <div class="mx-4 mt-3 p-4 bg-gray-800 rounded-lg shadow-md">
                <p class="text-base font-medium text-center text-gray-200" id="info"></p>
            </div>
        </main>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Инициализация карты без атрибуции
        const map = L.map('map', { attributionControl: false }).setView([55.7558, 37.6173], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Получаем username из URL
        const urlParams = new URLSearchParams(window.location.search);
        let username = urlParams.get('username') || '@vanekking22';

        // Загружаем данные из localStorage или используем значения по умолчанию
        let locations = JSON.parse(localStorage.getItem('locations')) || {
            '@vanekking22': {
                lat: 55.7558,
                lon: 37.6173,
                place_name: 'Москва, Красная площадь',
                avatar_url: 'photos/avatar_vanekking22.jpg'
            }
        };

        // Текущий маркер
        let currentMarker = null;

        // Функция обновления карты
        function updateMap() {
            const userData = locations[username] || {
                lat: 55.7558,
                lon: 37.6173,
                place_name: 'Москва, Красная площадь',
                avatar_url: 'photos/avatar_vanekking22.jpg'
            };

            // Удаляем старый маркер
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Создаем кастомный маркер с аватаром
            const avatarIcon = L.divIcon({
                className: 'avatar-marker',
                html: `<img src="${userData.avatar_url}" style="width: 40px; height: 40px; border-radius: 50%;" onerror="this.src='https://via.placeholder.com/40';" />`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });

            // Добавляем новый маркер
            currentMarker = L.marker([userData.lat, userData.lon], { icon: avatarIcon }).addTo(map);
            map.setView([userData.lat, userData.lon], 13);

            // Обновляем подпись
            document.getElementById('info').textContent = `Пользователь ${username} находится тут: ${userData.place_name}`;
        }

        // Инициализация карты
        updateMap();
    </script>
</body>
</html>